name: Release

on:
  workflow_dispatch:
    inputs:
      openclaw_version:
        description: 'OpenClaw version to track (e.g., 2026.1.30)'
        required: false
        type: string
      force:
        description: 'Force release even if tag exists'
        required: false
        type: boolean
        default: false
  schedule:
    # Check for new releases daily at 00:00 UTC
    - cron: '0 0 * * *'

env:
  CARGO_TERM_COLOR: always

jobs:
  check-release:
    runs-on: ubuntu-latest
    outputs:
      should_release: ${{ steps.check.outputs.should_release }}
      openclaw_version: ${{ steps.check.outputs.openclaw_version }}
      chitin_version: ${{ steps.check.outputs.chitin_version }}
      release_tag: ${{ steps.check.outputs.release_tag }}
      needs_source_update: ${{ steps.check.outputs.needs_source_update }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Determine versions and check release
        id: check
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Get OpenClaw version (from input or upstream)
          if [ -n "${{ inputs.openclaw_version }}" ]; then
            OPENCLAW_VERSION="${{ inputs.openclaw_version }}"
          else
            OPENCLAW_VERSION=$(curl -s https://api.github.com/repos/openclaw/openclaw/releases/latest | jq -r '.tag_name' | sed 's/^v//')
          fi
          echo "openclaw_version=$OPENCLAW_VERSION" >> $GITHUB_OUTPUT

          # Get chitin version from Cargo.toml
          CHITIN_VERSION=$(grep '^version' Cargo.toml | head -1 | sed 's/.*"\(.*\)".*/\1/')
          echo "chitin_version=$CHITIN_VERSION" >> $GITHUB_OUTPUT

          # Determine release tag
          RELEASE_TAG="v${CHITIN_VERSION}-openclaw${OPENCLAW_VERSION}"
          echo "release_tag=$RELEASE_TAG" >> $GITHUB_OUTPUT

          # Check if source needs updating
          CURRENT_OPENCLAW=$(grep 'OPENCLAW_VERSION' src/main.rs | head -1 | sed 's/.*"\(.*\)".*/\1/')
          if [ "$OPENCLAW_VERSION" != "$CURRENT_OPENCLAW" ]; then
            echo "needs_source_update=true" >> $GITHUB_OUTPUT
          else
            echo "needs_source_update=false" >> $GITHUB_OUTPUT
          fi

          # Check if release already exists
          if [ "${{ inputs.force }}" = "true" ]; then
            echo "Force release requested"
            echo "should_release=true" >> $GITHUB_OUTPUT
          elif gh release view "$RELEASE_TAG" > /dev/null 2>&1; then
            echo "Release $RELEASE_TAG already exists"
            echo "should_release=false" >> $GITHUB_OUTPUT
          else
            echo "Will create release $RELEASE_TAG"
            echo "should_release=true" >> $GITHUB_OUTPUT
          fi

  build:
    needs: check-release
    if: needs.check-release.outputs.should_release == 'true'
    strategy:
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
            name: chitin-linux-x86_64
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-latest
            name: chitin-linux-aarch64
          - target: x86_64-apple-darwin
            os: macos-latest
            name: chitin-macos-x86_64
          - target: aarch64-apple-darwin
            os: macos-latest
            name: chitin-macos-aarch64
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Update OpenClaw version if needed
        if: needs.check-release.outputs.needs_source_update == 'true'
        run: |
          sed -i.bak "s/OPENCLAW_VERSION: &str = \".*\"/OPENCLAW_VERSION: \&str = \"${{ needs.check-release.outputs.openclaw_version }}\"/" src/main.rs

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install cross-compilation tools (Linux aarch64)
        if: matrix.target == 'aarch64-unknown-linux-gnu'
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu

      - name: Build
        run: |
          if [ "${{ matrix.target }}" = "aarch64-unknown-linux-gnu" ]; then
            export CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=aarch64-linux-gnu-gcc
          fi
          cargo build --release --target ${{ matrix.target }}

      - name: Package
        run: |
          mkdir -p dist
          cp target/${{ matrix.target }}/release/chitin dist/${{ matrix.name }}
          chmod +x dist/${{ matrix.name }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.name }}
          path: dist/${{ matrix.name }}

  release:
    needs: [check-release, build]
    if: needs.check-release.outputs.should_release == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release
          for dir in artifacts/chitin-*; do
            if [ -d "$dir" ]; then
              name=$(basename "$dir")
              cp "$dir/$name" "release/$name"
              chmod +x "release/$name"
            fi
          done
          ls -la release/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.check-release.outputs.release_tag }}
          name: Chitin ${{ needs.check-release.outputs.chitin_version }} (OpenClaw ${{ needs.check-release.outputs.openclaw_version }})
          body: |
            Chitin release tracking OpenClaw v${{ needs.check-release.outputs.openclaw_version }}

            ## Downloads

            | Platform | Architecture | Download |
            |----------|--------------|----------|
            | Linux | x86_64 | `chitin-linux-x86_64` |
            | Linux | aarch64 | `chitin-linux-aarch64` |
            | macOS | x86_64 (Intel) | `chitin-macos-x86_64` |
            | macOS | aarch64 (Apple Silicon) | `chitin-macos-aarch64` |

            ## Installation

            ```bash
            # Download for your platform
            curl -LO https://github.com/${{ github.repository }}/releases/download/${{ needs.check-release.outputs.release_tag }}/chitin-linux-x86_64
            chmod +x chitin-linux-x86_64
            sudo mv chitin-linux-x86_64 /usr/local/bin/chitin
            ```

            ## Upstream

            - OpenClaw release: https://github.com/openclaw/openclaw/releases/tag/v${{ needs.check-release.outputs.openclaw_version }}
          files: release/*
          draft: false
          prerelease: false

  update-source:
    needs: [check-release, release]
    if: needs.check-release.outputs.should_release == 'true' && needs.check-release.outputs.needs_source_update == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Update and commit version
        run: |
          sed -i "s/OPENCLAW_VERSION: &str = \".*\"/OPENCLAW_VERSION: \&str = \"${{ needs.check-release.outputs.openclaw_version }}\"/" src/main.rs
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add src/main.rs
          git commit -m "Track OpenClaw v${{ needs.check-release.outputs.openclaw_version }}"
          git push
